# 基本設計書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | 基本設計書 |
| プロジェクト名 | img-resizer |
| バージョン | 1.0.0 |
| 作成日 | 2024年 |
| 最終更新日 | 2024年 |
| 作成者 | - |
| 承認者 | - |
| 関連ドキュメント | [要件定義書](./要件定義書.md), [詳細設計書](./詳細設計書.md) |

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
img-resizer

### 1.2 プロジェクトの目的
画像を512×512の正方形に変換するWebAPIアプリケーション。2種類の変換方式（全体変換方式・中央クロップ方式）をサポートする。

### 1.3 技術スタック

- **フレームワーク**: .NET 8
- **言語**: C#
- **アーキテクチャ**: クリーンアーキテクチャ
- **API**: ASP.NET Core WebAPI
- **画像処理**: System.Drawing.Common

### 1.4 機能要件

- 指定されたファイルパスの画像を512×512の正方形に変換
- **2種類の変換方式**:
  - **全体変換方式（fit）**: アスペクト比を維持したリサイズ + パディング
  - **中央クロップ方式（crop）**: 画像の中央部分を切り出してリサイズ
- ファイルパスは設定ファイル（`appsettings.json`）から取得
- WebAPIエンドポイント経由で画像変換を実行

---

## 2. アーキテクチャ概要

### 2.1 クリーンアーキテクチャの原則

1. **依存関係の方向**: 外側のレイヤーは内側のレイヤーに依存する
2. **独立性**: ビジネスロジックはフレームワークやUIから独立
3. **テスタビリティ**: 各レイヤーを独立してテスト可能

### 2.2 レイヤー構成

```
┌─────────────────────────────────────┐
│   Presentation (WebAPI)            │  ← 最外層
├─────────────────────────────────────┤
│   Application (Use Cases)          │
├─────────────────────────────────────┤
│   Domain (Entities, Interfaces)     │  ← 最内層
├─────────────────────────────────────┤
│   Infrastructure (Implementations)  │
└─────────────────────────────────────┘
```

### 2.3 レイヤー間の依存関係

```
Presentation → Application → Domain
     ↓              ↓
Infrastructure → Domain
```

**依存関係のルール**:
- **Domain層**: 他のレイヤーに依存しない（最内層）
- **Application層**: Domain層のみに依存
- **Infrastructure層**: Domain層に依存（インターフェースの実装）
- **Presentation層**: Application層とInfrastructure層に依存

---

## 3. プロジェクト構造

```
img-resizer/
├── src/
│   ├── ImgResizer.Api/              # Presentation層（WebAPI）
│   │   ├── Controllers/
│   │   │   └── ImageController.cs
│   │   ├── Program.cs
│   │   └── appsettings.json
│   │
│   ├── ImgResizer.Application/       # Application層（ユースケース）
│   │   ├── UseCases/
│   │   │   └── ResizeImageUseCase.cs
│   │   ├── DTOs/
│   │   │   ├── ResizeImageRequest.cs
│   │   │   └── ResizeImageResponse.cs
│   │   └── Interfaces/
│   │
│   ├── ImgResizer.Domain/            # Domain層（エンティティ、インターフェース）
│   │   ├── Entities/
│   │   │   └── ImageFile.cs
│   │   ├── Interfaces/
│   │   │   ├── IImageRepository.cs
│   │   │   └── IImageResizeService.cs
│   │   └── Exceptions/
│   │
│   └── ImgResizer.Infrastructure/    # Infrastructure層（実装）
│       ├── Services/
│       │   └── ImageResizeService.cs
│       ├── Repositories/
│       │   └── FileSystemImageRepository.cs
│       └── Configuration/
│           └── ImageResizeSettings.cs
│
├── tests/
│   ├── ImgResizer.Application.Tests/
│   ├── ImgResizer.Domain.Tests/
│   └── ImgResizer.Infrastructure.Tests/
│
└── img-resizer.sln
```

---

## 4. 各レイヤーの責務

### 4.1 Domain層（最内層）

**責務**:
- ビジネスエンティティの定義
- ビジネスルール
- インターフェースの定義（リポジトリ、サービス）

**依存関係**: なし（他のレイヤーに依存しない）

**主要コンポーネント**:
- `ImageFile`: 画像ファイルを表すエンティティ
- `IImageRepository`: 画像ファイルの読み書きを行うインターフェース
- `IImageResizeService`: 画像リサイズ処理を行うインターフェース

### 4.2 Application層

**責務**:
- ユースケースの実装
- ビジネスロジックのオーケストレーション
- DTO（Data Transfer Object）の定義

**依存関係**: Domain層のみ

**主要コンポーネント**:
- `ResizeImageUseCase`: 画像を512×512にリサイズするユースケース
- `ResizeImageRequest`: リクエストDTO
- `ResizeImageResponse`: レスポンスDTO

### 4.3 Infrastructure層

**責務**:
- 外部ライブラリ（System.Drawing等）の使用
- ファイルシステムへのアクセス
- 設定ファイルの読み込み
- Domain層で定義されたインターフェースの実装

**依存関係**: Domain層

**主要コンポーネント**:
- `ImageResizeService`: 画像リサイズ処理の実装
- `FileSystemImageRepository`: ファイルシステムへのアクセス実装
- `ImageResizeSettings`: 設定ファイルの読み込み

### 4.4 Presentation層（WebAPI）

**責務**:
- HTTPリクエスト/レスポンスの処理
- ルーティング
- 依存性注入の設定
- エラーハンドリング

**依存関係**: Application層、Infrastructure層

**主要コンポーネント**:
- `ImageController`: 画像変換APIのエンドポイント
- `Program.cs`: アプリケーションのエントリーポイント、DI設定

---

## 5. API設計

### 5.1 エンドポイント概要

**エンドポイント**: `POST /api/image/resize`

**機能**: 指定されたファイルパスの画像を512×512の正方形に変換する。2種類の変換方式をサポートする。

**詳細は[API仕様書](./API仕様書.md)を参照**

### 5.2 リクエスト概要

**リクエストボディ（全体変換方式）**:
```json
{
  "filePath": "C:\\images\\input.jpg",
  "resizeMode": "fit"
}
```

**リクエストボディ（中央クロップ方式）**:
```json
{
  "filePath": "C:\\images\\input.jpg",
  "resizeMode": "crop"
}
```

**リクエストパラメータ**:
| 項目 | 型 | 必須 | 説明 | 値 |
|------|-----|------|------|-----|
| filePath | string | 必須 | 画像ファイルのパス | - |
| resizeMode | string | オプション | 変換方式 | `fit`（全体変換、デフォルト）または `crop`（中央クロップ） |

### 5.3 レスポンス概要

**正常系（200 OK）**:
```json
{
  "success": true,
  "message": "画像を512×512に変換しました",
  "outputPath": "C:\\images\\output_512x512.jpg",
  "resizeMode": "fit"
}
```

**異常系（400/404/500）**:
```json
{
  "success": false,
  "message": "エラーメッセージ",
  "errorCode": "ERROR_CODE"
}
```

**HTTPステータスコード**:
- `200 OK`: 変換成功
- `400 Bad Request`: リクエストが不正
- `404 Not Found`: ファイルが見つからない
- `500 Internal Server Error`: サーバーエラー

---

## 6. 設定ファイル設計

### 6.1 設定ファイル概要

**ファイル**: `appsettings.json`

**主要設定項目**:
- 入力ディレクトリパス
- 出力ディレクトリパス
- ターゲットサイズ（幅・高さ）
- 許可された拡張子リスト
- 最大ファイルサイズ
- パディング色（オプション）
- 画像品質設定（オプション）

**詳細は[データ仕様書](./データ仕様書.md)を参照**

### 6.2 設定クラス概要

```csharp
public class ImageResizeSettings
{
    public string InputDirectory { get; set; } = string.Empty;
    public string OutputDirectory { get; set; } = string.Empty;
    public TargetSizeSettings TargetSize { get; set; } = new();
    public string[] AllowedExtensions { get; set; } = Array.Empty<string>();
    public long MaxFileSize { get; set; } = 52428800; // 50MB
    public PaddingColorSettings? PaddingColor { get; set; }
}
```

---

## 7. 画像変換ロジック概要

### 7.1 全体変換方式（fit）

**処理概要**:
1. 元画像を読み込む
2. 元画像のアスペクト比を計算
3. 512×512の正方形に収まるようにリサイズ（アスペクト比を維持）
4. 余白を黒（または指定色）で埋めて正方形にする
5. 変換後の画像を保存

**出力ファイル名**: `{元のファイル名}_512x512.{拡張子}`

### 7.2 中央クロップ方式（crop）

**処理概要**:
1. 元画像を読み込む
2. 画像の中央部分を正方形として切り出す
3. 切り出した部分を512×512にリサイズ
4. 変換後の画像を保存

**出力ファイル名**: `{元のファイル名}_512x512_crop.{拡張子}`

**詳細は[詳細設計書](./詳細設計書.md)を参照**

---

## 8. エラーハンドリング概要

### 8.1 エラーコード一覧

| エラーコード | 説明 | HTTPステータス |
|------------|------|---------------|
| `FILE_NOT_FOUND` | ファイルが見つからない | 404 |
| `INVALID_FILE_FORMAT` | サポートされていない画像形式 | 400 |
| `FILE_READ_ERROR` | ファイル読み込みエラー | 500 |
| `FILE_WRITE_ERROR` | ファイル書き込みエラー | 500 |
| `INVALID_CONFIGURATION` | 設定ファイルが不正 | 500 |
| `INVALID_REQUEST` | リクエストが不正 | 400 |
| `FILE_TOO_LARGE` | ファイルサイズが大きすぎる | 400 |
| `INTERNAL_SERVER_ERROR` | サーバー内部エラー | 500 |

**詳細は[詳細設計書](./詳細設計書.md)を参照**

---

## 9. 依存性注入（DI）概要

### 9.1 登録するサービス

- `IImageRepository` → `FileSystemImageRepository` (Scoped)
- `IImageResizeService` → `ImageResizeService` (Scoped)
- `ResizeImageUseCase` (Scoped)
- `ImageResizeSettings` (Configuration)

**詳細は[詳細設計書](./詳細設計書.md)を参照**

---

## 10. テスト戦略

### 10.1 単体テスト

- **Domain層**: エンティティのビジネスルール
- **Application層**: ユースケースのロジック（モックを使用）
- **Infrastructure層**: サービス実装のテスト

### 10.2 統合テスト

- APIエンドポイントのテスト
- ファイルシステムとの統合テスト

**詳細は[テスト仕様書](./テスト仕様書.md)（作成予定）を参照**

---

## 11. 今後の拡張性

### 11.1 機能拡張の方向性

- 複数の画像形式への対応
- 非同期処理の実装
- 画像のメタデータ保持
- バッチ処理機能
- 画像の品質設定（圧縮率など）
- 複数サイズへの対応（512×512以外）

### 11.2 アーキテクチャの拡張性

- クリーンアーキテクチャにより、各レイヤーが独立して拡張可能
- インターフェースによる依存関係の逆転により、実装の差し替えが容易
- 新しい変換方式の追加が容易

---

## 12. 関連ドキュメント

- [要件定義書](./要件定義書.md)
- [機能仕様書](./機能仕様書.md)
- [API仕様書](./API仕様書.md)
- [データ仕様書](./データ仕様書.md)
- [詳細設計書](./詳細設計書.md)

---

## 13. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|----------|--------|
| 1.0.0 | - | 初版作成 | - |

