# 機能仕様書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | 機能仕様書 |
| プロジェクト名 | img-resizer |
| バージョン | 1.0.0 |
| 作成日 | 2024年 |
| 最終更新日 | 2024年 |
| 作成者 | - |
| 承認者 | - |
| 関連ドキュメント | [要件定義書](./要件定義書.md), [基本設計書](./基本設計書.md), [詳細設計書](./詳細設計書.md), [API仕様書](./API仕様書.md), [データ仕様書](./データ仕様書.md) |

---

## 1. 概要

### 1.1 目的
このドキュメントは、img-resizerプロジェクトの各機能の詳細な動作仕様を定義します。実装時に参照する詳細仕様書として使用されます。

### 1.2 対象読者
- 開発者
- テストエンジニア
- プロジェクトマネージャー

### 1.3 用語定義
- **アスペクト比**: 画像の幅と高さの比率（幅 ÷ 高さ）
- **パディング**: 画像の周囲に余白を追加すること
- **リサンプリング**: 画像のサイズを変更する際の画素補間処理
- **DTO**: Data Transfer Object（データ転送オブジェクト）

---

## 2. 機能一覧

| 機能ID | 機能名 | 優先度 | 状態 |
|--------|--------|--------|------|
| FR-001 | 画像ファイルの読み込み | 必須 | 仕様定義済み |
| FR-002 | 画像の正方形変換（全体変換方式） | 必須 | 仕様定義済み |
| FR-002-2 | 画像の正方形変換（中央クロップ方式） | 必須 | 仕様定義済み |
| FR-003 | 画像ファイルの保存 | 必須 | 仕様定義済み |
| FR-004 | RESTful APIエンドポイント | 必須 | 仕様定義済み |
| FR-005 | リクエストバリデーション | 必須 | 仕様定義済み |
| FR-006 | エラーハンドリング | 必須 | 仕様定義済み |
| FR-007 | 設定ファイル管理 | 必須 | 仕様定義済み |
| FR-008 | ロギング機能 | 推奨 | 仕様定義済み |

---

## 3. 機能詳細仕様

### 3.1 FR-001: 画像ファイルの読み込み

#### 3.1.1 機能概要
指定されたファイルパスから画像ファイルを読み込み、バイト配列として取得する機能。

#### 3.1.2 入力仕様

| 項目 | 型 | 必須 | 説明 | 制約 |
|------|-----|------|------|------|
| filePath | string | 必須 | 画像ファイルのパス | 絶対パスまたは相対パス、最大長: 260文字（Windows） |

**入力例**:
```
C:\images\input\photo.jpg
```

#### 3.1.3 出力仕様

**正常系**:
| 項目 | 型 | 説明 |
|------|-----|------|
| imageData | byte[] | 画像データのバイト配列 |

**異常系**:
| 項目 | 型 | 説明 |
|------|-----|------|
| errorCode | string | エラーコード（`FILE_NOT_FOUND`, `FILE_READ_ERROR`等） |
| message | string | エラーメッセージ |

#### 3.1.4 処理フロー

```
1. ファイルパスのバリデーション
   ├─ ファイルパスが空でないか確認
   ├─ ファイルパスが有効な形式か確認
   └─ パストラバーサル攻撃のチェック
   ↓
2. ファイル存在確認
   ├─ File.Exists()でファイルの存在を確認
   └─ 存在しない場合: FILE_NOT_FOUNDエラー
   ↓
3. 拡張子の検証
   ├─ 拡張子を取得
   ├─ 許可リストに含まれるか確認
   └─ 含まれない場合: INVALID_FILE_FORMATエラー
   ↓
4. ファイルサイズチェック
   ├─ ファイルサイズを取得
   ├─ 最大サイズ（50MB）を超えていないか確認
   └─ 超えている場合: FILE_TOO_LARGEエラー
   ↓
5. ファイル読み込み
   ├─ File.ReadAllBytesAsync()で非同期読み込み
   └─ 読み込み失敗時: FILE_READ_ERRORエラー
   ↓
6. 画像データの返却
   └─ バイト配列を返却
```

#### 3.1.5 ビジネスルール

1. **ファイルパスの検証**
   - ファイルパスは空文字列であってはならない
   - ファイルパスに `..` や `~` などの危険な文字列が含まれていないか確認
   - ファイルパスは正規化する（`Path.GetFullPath()`を使用）

2. **拡張子の検証**
   - 許可された拡張子のみ処理対象とする
   - 許可リスト: `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`
   - 拡張子の比較は大文字小文字を区別しない

3. **ファイルサイズ制限**
   - 最大ファイルサイズ: 50MB（52,428,800バイト）
   - 制限を超える場合はエラーを返す

#### 3.1.6 エッジケース

| ケース | 処理 |
|--------|------|
| ファイルパスが空文字列 | `INVALID_REQUEST`エラーを返す |
| ファイルが存在しない | `FILE_NOT_FOUND`エラーを返す |
| ファイルへのアクセス権限がない | `FILE_READ_ERROR`エラーを返す |
| ファイルが破損している | `FILE_READ_ERROR`エラーを返す |
| ファイルサイズが0バイト | `FILE_READ_ERROR`エラーを返す |
| ファイルサイズが50MBを超える | `FILE_TOO_LARGE`エラーを返す |
| サポートされていない拡張子 | `INVALID_FILE_FORMAT`エラーを返す |

#### 3.1.7 実装レイヤー
- **Domain層**: `IImageRepository`インターフェース
- **Infrastructure層**: `FileSystemImageRepository`実装

---

### 3.2 FR-002: 画像の正方形変換（全体変換方式）

#### 3.2.1 機能概要
読み込んだ画像を512×512ピクセルの正方形に変換する機能（全体変換方式）。アスペクト比を維持したリサイズとパディング処理を行う。画像全体が512×512の正方形に収まるように変換する。

#### 3.2.2 入力仕様

| 項目 | 型 | 必須 | 説明 | 制約 |
|------|-----|------|------|------|
| imageData | byte[] | 必須 | 元画像データ | 空でない、有効な画像形式 |
| targetSize | int | 必須 | ターゲットサイズ | 512（固定） |
| resizeMode | string | オプション | 変換方式 | `fit`（デフォルト） |

#### 3.2.3 出力仕様

| 項目 | 型 | 説明 |
|------|-----|------|
| resizedImageData | byte[] | 変換後の画像データ（512×512） |

#### 3.2.4 処理フロー

```
1. 画像データの読み込み
   ├─ MemoryStreamから画像を読み込む
   ├─ SixLabors.ImageSharpを使用
   └─ 読み込み失敗時: IMAGE_LOAD_ERRORエラー
   ↓
2. 元画像のサイズ取得
   ├─ Width（幅）を取得
   └─ Height（高さ）を取得
   ↓
3. アスペクト比の計算
   └─ aspectRatio = Width / Height
   ↓
4. リサイズサイズの決定
   ├─ Width > Height の場合
   │  ├─ newWidth = 512
   │  └─ newHeight = (int)(512 / aspectRatio)
   └─ Height >= Width の場合
      ├─ newHeight = 512
      └─ newWidth = (int)(512 * aspectRatio)
   ↓
5. リサイズ処理
   ├─ 高品質リサンプリングアルゴリズムを使用
   │  └─ InterpolationMode.HighQualityBicubic
   └─ リサイズした画像を作成
   ↓
6. 正方形キャンバスの作成
   ├─ 512×512のBitmapを作成
   └─ パディング色（黒: RGB(0,0,0)）で初期化
   ↓
7. 画像の中央配置
   ├─ x = (512 - newWidth) / 2
   ├─ y = (512 - newHeight) / 2
   └─ Graphics.DrawImage()で中央に配置
   ↓
8. 画像データの変換
   ├─ MemoryStreamに保存
   ├─ 元の画像形式を維持
   └─ バイト配列に変換
   ↓
9. リソースの解放
   └─ usingステートメントで適切に解放
   ↓
10. 変換後の画像データを返却
```

#### 3.2.5 ビジネスルール

1. **アスペクト比の維持**
   - 元画像のアスペクト比を必ず維持する
   - 画像を歪ませない

2. **リサイズサイズの決定**
   - 幅と高さのうち、大きい方に合わせて512pxにスケール
   - 小さい方はアスペクト比に基づいて計算

3. **パディング**
   - 余白部分は黒色（RGB(0,0,0)）で埋める
   - 将来的には設定ファイルから色を指定可能にする

4. **リサンプリングアルゴリズム**
   - `HighQualityBicubic`を使用して高品質なリサイズを実現

5. **画像形式の維持**
   - 元の画像形式（JPEG、PNG等）を維持して保存

#### 3.2.6 エッジケース

| ケース | 処理 |
|--------|------|
| 元画像が既に512×512 | そのまま返す（パディングのみ） |
| 元画像が正方形（例: 800×800） | 512×512にリサイズ |
| 元画像が横長（例: 1920×1080） | 幅512pxに合わせてリサイズ、上下にパディング |
| 元画像が縦長（例: 1080×1920） | 高さ512pxに合わせてリサイズ、左右にパディング |
| 元画像が非常に小さい（例: 10×10） | 512×512に拡大、周囲にパディング |
| 画像データが破損している | `IMAGE_LOAD_ERROR`エラーを返す |
| 画像形式が不正 | `IMAGE_LOAD_ERROR`エラーを返す |

#### 3.2.7 実装レイヤー
- **Domain層**: `IImageResizeService`インターフェース
- **Infrastructure層**: `ImageResizeService`実装

#### 3.2.8 計算式

**アスペクト比の計算**:
```
aspectRatio = originalWidth / originalHeight
```

**リサイズサイズの計算（横長の場合）**:
```
newWidth = 512
newHeight = (int)(512 / aspectRatio)
```

**リサイズサイズの計算（縦長の場合）**:
```
newHeight = 512
newWidth = (int)(512 * aspectRatio)
```

**中央配置の座標計算**:
```
x = (512 - newWidth) / 2
y = (512 - newHeight) / 2
```

---

### 3.2-2 FR-002-2: 画像の正方形変換（中央クロップ方式）

#### 3.2-2.1 機能概要
読み込んだ画像の中央部分を512×512ピクセルの正方形として切り出し、リサイズして変換する機能。画像の中央部分をクロップして正方形に変換する。

#### 3.2-2.2 入力仕様

| 項目 | 型 | 必須 | 説明 | 制約 |
|------|-----|------|------|------|
| imageData | byte[] | 必須 | 元画像データ | 空でない、有効な画像形式 |
| targetSize | int | 必須 | ターゲットサイズ | 512（固定） |
| resizeMode | string | 必須 | 変換方式 | `crop` |

#### 3.2-2.3 出力仕様

| 項目 | 型 | 説明 |
|------|-----|------|
| resizedImageData | byte[] | 変換後の画像データ（512×512） |

#### 3.2-2.4 処理フロー

```
1. 画像データの読み込み
   ├─ MemoryStreamから画像を読み込む
   ├─ SixLabors.ImageSharpを使用
   └─ 読み込み失敗時: IMAGE_LOAD_ERRORエラー
   ↓
2. 元画像のサイズ取得
   ├─ Width（幅）を取得
   └─ Height（高さ）を取得
   ↓
3. クロップサイズの決定
   ├─ cropSize = Min(Width, Height)
   └─ 元画像が512×512より小さい場合は、そのまま512×512に拡大
   ↓
4. 中央位置の計算
   ├─ x = (Width - cropSize) / 2
   └─ y = (Height - cropSize) / 2
   ↓
5. 中央部分の切り出し
   ├─ Rectangle(x, y, cropSize, cropSize)で切り出し
   └─ Bitmap.Clone()を使用
   ↓
6. リサイズ処理
   ├─ 切り出した画像を512×512にリサイズ
   ├─ 高品質リサンプリングアルゴリズムを使用
   │  └─ InterpolationMode.HighQualityBicubic
   └─ リサイズした画像を作成
   ↓
7. 画像データの変換
   ├─ MemoryStreamに保存
   ├─ 元の画像形式を維持
   └─ バイト配列に変換
   ↓
8. リソースの解放
   └─ usingステートメントで適切に解放
   ↓
9. 変換後の画像データを返却
```

#### 3.2-2.5 ビジネスルール

1. **中央クロップ**
   - 画像の中央部分を正方形として切り出す
   - 幅と高さのうち小さい方をクロップサイズとする

2. **リサイズ**
   - 切り出した正方形画像を512×512にリサイズ
   - 高品質なリサンプリングアルゴリズムを使用

3. **小さい画像の処理**
   - 元画像が512×512より小さい場合は、そのまま512×512に拡大する
   - クロップは行わず、全体を拡大

4. **画像形式の維持**
   - 元の画像形式（JPEG、PNG等）を維持して保存

#### 3.2-2.6 エッジケース

| ケース | 処理 |
|--------|------|
| 元画像が既に512×512 | そのまま返す |
| 元画像が正方形（例: 800×800） | 中央800×800を切り出し、512×512にリサイズ |
| 元画像が横長（例: 1920×1080） | 中央1080×1080を切り出し、512×512にリサイズ |
| 元画像が縦長（例: 1080×1920） | 中央1080×1080を切り出し、512×512にリサイズ |
| 元画像が非常に小さい（例: 10×10） | そのまま512×512に拡大（クロップなし） |
| 元画像が512×512より小さい | そのまま512×512に拡大（クロップなし） |
| 画像データが破損している | `IMAGE_LOAD_ERROR`エラーを返す |
| 画像形式が不正 | `IMAGE_LOAD_ERROR`エラーを返す |

#### 3.2-2.7 実装レイヤー
- **Domain層**: `IImageResizeService`インターフェース
- **Infrastructure層**: `ImageResizeService`実装

#### 3.2-2.8 変換方式の指定
- リクエストで `resizeMode: "crop"` を指定した場合に中央クロップ方式が適用される
- 出力ファイル名は `{元のファイル名}_512x512_crop.{拡張子}` となる

#### 3.2-2.9 計算式

**クロップサイズの計算**:
```
cropSize = Min(originalWidth, originalHeight)
```

**中央位置の計算**:
```
x = (originalWidth - cropSize) / 2
y = (originalHeight - cropSize) / 2
```

**小さい画像の判定**:
```
if (originalWidth < 512 || originalHeight < 512)
{
    // そのまま512×512に拡大（クロップなし）
}
```

---

### 3.3 FR-003: 画像ファイルの保存

#### 3.3.1 機能概要
変換後の画像を指定された出力ディレクトリに保存する機能。

#### 3.3.2 入力仕様

| 項目 | 型 | 必須 | 説明 | 制約 |
|------|-----|------|------|------|
| imageData | byte[] | 必須 | 変換後の画像データ | 空でない |
| outputPath | string | 必須 | 出力ファイルパス | 有効なファイルパス |

#### 3.3.3 出力仕様

**正常系**:
| 項目 | 型 | 説明 |
|------|-----|------|
| savedPath | string | 保存されたファイルパス |

**異常系**:
| 項目 | 型 | 説明 |
|------|-----|------|
| errorCode | string | エラーコード（`FILE_WRITE_ERROR`等） |
| message | string | エラーメッセージ |

#### 3.3.4 処理フロー

```
1. 出力ディレクトリの取得
   ├─ 設定ファイルから出力ディレクトリを取得
   └─ 取得失敗時: INVALID_CONFIGURATIONエラー
   ↓
2. 出力ファイルパスの生成
   ├─ 元のファイル名を取得
   ├─ 拡張子を取得
   ├─ ファイル名に "_512x512" を付加
   └─ 出力ディレクトリと結合
   ↓
3. 出力ディレクトリの存在確認
   ├─ Directory.Exists()で確認
   └─ 存在しない場合: 自動作成
   ↓
4. ファイル書き込み権限の確認
   ├─ ディレクトリへの書き込み権限を確認
   └─ 権限がない場合: FILE_WRITE_ERRORエラー
   ↓
5. ディスク容量の確認（オプション）
   ├─ 必要なディスク容量を計算
   └─ 不足している場合: DISK_FULL_ERRORエラー
   ↓
6. ファイル保存
   ├─ File.WriteAllBytesAsync()で非同期保存
   └─ 保存失敗時: FILE_WRITE_ERRORエラー
   ↓
7. 保存されたファイルパスを返却
```

#### 3.3.5 ビジネスルール

1. **出力ファイル名の生成**
   - 全体変換方式の場合:
     - 元のファイル名: `photo.jpg`
     - 出力ファイル名: `photo_512x512.jpg`
   - 中央クロップ方式の場合:
     - 元のファイル名: `photo.jpg`
     - 出力ファイル名: `photo_512x512_crop.jpg`
   - 拡張子は元の形式を維持

2. **出力ディレクトリ**
   - 設定ファイル（`appsettings.json`）から取得
   - 存在しない場合は自動作成
   - 作成に失敗した場合はエラーを返す

3. **ファイル上書き**
   - 既存のファイルがある場合は上書きする
   - 将来的には上書き防止オプションを追加可能

#### 3.3.6 エッジケース

| ケース | 処理 |
|--------|------|
| 出力ディレクトリが存在しない | 自動作成する |
| 出力ディレクトリへの書き込み権限がない | `FILE_WRITE_ERROR`エラーを返す |
| ディスク容量不足 | `FILE_WRITE_ERROR`エラーを返す（将来的には`DISK_FULL_ERROR`） |
| 出力ファイル名が無効 | `FILE_WRITE_ERROR`エラーを返す |
| 既存のファイルがある | 上書きする |
| 出力パスが長すぎる（Windows: 260文字超） | `FILE_WRITE_ERROR`エラーを返す |

#### 3.3.7 実装レイヤー
- **Domain層**: `IImageRepository`インターフェース
- **Infrastructure層**: `FileSystemImageRepository`実装

---

### 3.4 FR-004: RESTful APIエンドポイント

#### 3.4.1 機能概要
HTTP経由で画像変換リクエストを受け付けるWebAPIエンドポイント。

#### 3.4.2 エンドポイント仕様

**エンドポイント**: `POST /api/image/resize`

**HTTPメソッド**: POST

**Content-Type**: `application/json`

#### 3.4.3 リクエスト仕様

**リクエストボディ**:
```json
{
  "filePath": "C:\\images\\input\\photo.jpg"
}
```

**リクエストパラメータ**:
| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| filePath | string | 必須 | 画像ファイルのパス |

#### 3.4.4 レスポンス仕様

**正常系（200 OK - 全体変換方式）**:
```json
{
  "success": true,
  "message": "画像を512×512に変換しました",
  "outputPath": "C:\\images\\output\\photo_512x512.jpg",
  "resizeMode": "fit"
}
```

**正常系（200 OK - 中央クロップ方式）**:
```json
{
  "success": true,
  "message": "画像を512×512に変換しました",
  "outputPath": "C:\\images\\output\\photo_512x512_crop.jpg",
  "resizeMode": "crop"
}
```

**異常系（400 Bad Request）**:
```json
{
  "success": false,
  "message": "リクエストが不正です",
  "errorCode": "INVALID_REQUEST"
}
```

**異常系（404 Not Found）**:
```json
{
  "success": false,
  "message": "ファイルが見つかりません: C:\\images\\input\\photo.jpg",
  "errorCode": "FILE_NOT_FOUND"
}
```

**異常系（500 Internal Server Error）**:
```json
{
  "success": false,
  "message": "サーバーエラーが発生しました",
  "errorCode": "INTERNAL_SERVER_ERROR"
}
```

#### 3.4.5 処理フロー

```
1. HTTPリクエスト受信
   ├─ POST /api/image/resize
   └─ Content-Type: application/json
   ↓
2. リクエストボディの解析
   ├─ JSONをResizeImageRequestにデシリアライズ
   └─ 解析失敗時: 400 Bad Request
   ↓
3. リクエストバリデーション（FR-005）
   ├─ ファイルパスの検証
   ├─ resizeModeの検証（fit または crop、省略時はfit）
   └─ バリデーション失敗時: 400 Bad Request
   ↓
4. UseCase実行
   ├─ ResizeImageUseCase.ExecuteAsync()を呼び出し
   ├─ resizeModeに応じて変換方式を選択
   │  ├─ "fit" → 全体変換方式
   │  └─ "crop" → 中央クロップ方式
   └─ 例外発生時: 500 Internal Server Error
   ↓
5. レスポンス生成
   ├─ ResizeImageResponseを作成
   └─ JSONにシリアライズ
   ↓
6. HTTPレスポンス返却
   ├─ 成功時: 200 OK
   ├─ クライアントエラー: 400 Bad Request
   ├─ ファイル未找到: 404 Not Found
   └─ サーバーエラー: 500 Internal Server Error
```

#### 3.4.6 シーケンス図

```
Client          Controller         UseCase          Repository      ResizeService
  |                 |                 |                 |                 |
  |--POST /api/image/resize---------->|                 |                 |
  |                 |                 |                 |                 |
  |                 |--ExecuteAsync()->|                 |                 |
  |                 |                 |                 |                 |
  |                 |                 |--FileExists()--->|                 |
  |                 |                 |<--true/false-----|                 |
  |                 |                 |                 |                 |
  |                 |                 |--ReadImageAsync()->|                 |
  |                 |                 |<--imageData------|                 |
  |                 |                 |                 |                 |
  |                 |                 |--ResizeToSquareAsync()-------->|
  |                 |                 |<--resizedData------------------|
  |                 |                 |                 |                 |
  |                 |                 |--SaveImageAsync()--->|                 |
  |                 |                 |<--savedPath--------|                 |
  |                 |                 |                 |                 |
  |                 |<--Response------|                 |                 |
  |<--200 OK--------|                 |                 |                 |
```

#### 3.4.7 実装レイヤー
- **Presentation層**: `ImageController`

---

### 3.5 FR-005: リクエストバリデーション

#### 3.5.1 機能概要
APIリクエストの妥当性を検証する機能。セキュリティとデータ整合性を保証する。

#### 3.5.2 検証項目

| 項目 | 検証内容 | エラーコード |
|------|----------|------------|
| ファイルパス | 空でない | `INVALID_REQUEST` |
| ファイルパス形式 | 有効なパス形式 | `INVALID_REQUEST` |
| パストラバーサル | 危険な文字列が含まれていない | `INVALID_REQUEST` |
| 拡張子 | 許可リストに含まれる | `INVALID_FILE_FORMAT` |

#### 3.5.3 検証ルール

1. **ファイルパスの必須チェック**
   ```csharp
   if (string.IsNullOrWhiteSpace(filePath))
   {
       throw new ValidationException("ファイルパスが指定されていません");
   }
   ```

2. **パストラバーサル攻撃の防止**
   ```csharp
   // 危険な文字列のチェック
   if (filePath.Contains("..") || filePath.Contains("~"))
   {
       throw new ValidationException("無効なファイルパスです");
   }
   
   // パスの正規化
   var normalizedPath = Path.GetFullPath(filePath);
   ```

3. **拡張子の検証**
   ```csharp
   var extension = Path.GetExtension(filePath).ToLower();
   var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp" };
   
   if (!allowedExtensions.Contains(extension))
   {
       throw new ValidationException($"サポートされていない画像形式です: {extension}");
   }
   ```

4. **resizeModeの検証**
   ```csharp
   var validModes = new[] { "fit", "crop" };
   var resizeMode = request.ResizeMode ?? "fit"; // デフォルトは"fit"
   
   if (!validModes.Contains(resizeMode.ToLower()))
   {
       throw new ValidationException($"無効な変換方式です: {resizeMode}。有効な値は 'fit' または 'crop' です。");
   }
   ```

#### 3.5.4 実装レイヤー
- **Application層**: `ResizeImageUseCase`内で実装

---

### 3.6 FR-006: エラーハンドリング

#### 3.6.1 機能概要
エラー発生時に適切なエラーレスポンスを返却し、ログに記録する機能。

#### 3.6.2 エラーコード一覧

| エラーコード | 説明 | HTTPステータス | 発生タイミング |
|------------|------|---------------|---------------|
| `FILE_NOT_FOUND` | ファイルが見つからない | 404 | ファイルが存在しない |
| `INVALID_FILE_FORMAT` | サポートされていない画像形式 | 400 | 拡張子が許可リストにない |
| `FILE_READ_ERROR` | ファイル読み込みエラー | 500 | ファイル読み込み失敗 |
| `FILE_WRITE_ERROR` | ファイル書き込みエラー | 500 | ファイル書き込み失敗 |
| `INVALID_CONFIGURATION` | 設定ファイルが不正 | 500 | 設定値が無効 |
| `INVALID_REQUEST` | リクエストが不正 | 400 | バリデーション失敗 |
| `INTERNAL_SERVER_ERROR` | サーバー内部エラー | 500 | 予期しないエラー |

#### 3.6.3 エラーハンドリングフロー

```
1. 例外発生
   ↓
2. 例外タイプの判定
   ├─ FileNotFoundException → FILE_NOT_FOUND
   ├─ UnsupportedFormatException → INVALID_FILE_FORMAT
   ├─ ValidationException → INVALID_REQUEST
   └─ その他 → INTERNAL_SERVER_ERROR
   ↓
3. エラーログの記録
   ├─ ログレベル: Error
   ├─ エラーコード
   ├─ エラーメッセージ
   └─ スタックトレース（開発環境のみ）
   ↓
4. エラーレスポンスの生成
   ├─ ResizeImageResponseを作成
   ├─ Success = false
   ├─ ErrorCodeを設定
   └─ Messageを設定
   ↓
5. HTTPレスポンス返却
   └─ 適切なHTTPステータスコードと共に返却
```

#### 3.6.4 実装レイヤー
- **Presentation層**: `ImageController`内でグローバルエラーハンドリング
- **Application層**: カスタム例外クラス

---

### 3.7 FR-007: 設定ファイル管理

#### 3.7.1 機能概要
アプリケーション設定を設定ファイルから読み込む機能。

#### 3.7.2 設定ファイル仕様

**appsettings.json**:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ImageResize": {
    "InputDirectory": "C:\\images\\input",
    "OutputDirectory": "C:\\images\\output",
    "TargetSize": {
      "Width": 512,
      "Height": 512
    },
    "AllowedExtensions": [".jpg", ".jpeg", ".png", ".gif", ".bmp"],
    "MaxFileSize": 52428800,
    "PaddingColor": {
      "R": 0,
      "G": 0,
      "B": 0,
      "A": 255
    }
  }
}
```

#### 3.7.3 設定項目

| 項目 | 型 | 必須 | デフォルト値 | 説明 |
|------|-----|------|------------|------|
| InputDirectory | string | 必須 | - | 入力ディレクトリパス |
| OutputDirectory | string | 必須 | - | 出力ディレクトリパス |
| TargetSize.Width | int | 必須 | 512 | ターゲット幅 |
| TargetSize.Height | int | 必須 | 512 | ターゲット高さ |
| AllowedExtensions | string[] | 必須 | - | 許可された拡張子リスト |
| MaxFileSize | long | 推奨 | 52428800 | 最大ファイルサイズ（バイト） |
| PaddingColor.R | int | オプション | 0 | パディング色（赤） |
| PaddingColor.G | int | オプション | 0 | パディング色（緑） |
| PaddingColor.B | int | オプション | 0 | パディング色（青） |
| PaddingColor.A | int | オプション | 255 | パディング色（透明度） |

#### 3.7.4 設定値のバリデーション

1. **必須項目のチェック**
   - InputDirectory、OutputDirectory、TargetSize、AllowedExtensionsは必須

2. **値の範囲チェック**
   - TargetSize.Width/Height: 1以上、4096以下
   - MaxFileSize: 1MB以上、100MB以下
   - PaddingColor.R/G/B/A: 0～255

#### 3.7.5 実装レイヤー
- **Infrastructure層**: `ImageResizeSettings`クラス
- **Presentation層**: `Program.cs`で設定を読み込み

---

### 3.8 FR-008: ロギング機能

#### 3.8.1 機能概要
アプリケーションの動作を記録するロギング機能。

#### 3.8.2 ログレベル

| レベル | 用途 | 出力内容 |
|--------|------|----------|
| Information | 正常な処理完了 | リクエスト受信、処理完了 |
| Warning | 警告 | 設定値のデフォルト使用 |
| Error | エラー | 例外発生、エラー詳細 |
| Debug | デバッグ情報 | 詳細な処理情報（開発環境のみ） |

#### 3.8.3 ログ出力箇所

1. **リクエスト受信時**
   ```csharp
   _logger.LogInformation("画像変換リクエスト受信: {FilePath}", request.FilePath);
   ```

2. **処理開始時**
   ```csharp
   _logger.LogDebug("画像変換処理開始: {FilePath}", request.FilePath);
   ```

3. **処理完了時**
   ```csharp
   _logger.LogInformation("画像変換処理完了: {OutputPath}", response.OutputPath);
   ```

4. **エラー発生時**
   ```csharp
   _logger.LogError(ex, "画像変換中にエラーが発生: {FilePath}, ErrorCode: {ErrorCode}", 
       request.FilePath, errorCode);
   ```

#### 3.8.4 実装レイヤー
- **全レイヤー**: `ILogger<T>`を使用

---

## 4. 統合フロー

### 4.1 全体処理フロー

```
[Client]
  |
  | POST /api/image/resize
  | { "filePath": "C:\\images\\input.jpg" }
  |
  v
[ImageController]
  |
  | 1. リクエスト受信・ログ記録
  | 2. リクエストバリデーション
  |
  v
[ResizeImageUseCase]
  |
  | 3. ファイル存在確認
  |    └─> [FileSystemImageRepository.FileExists()]
  |
  | 4. 画像読み込み
  |    └─> [FileSystemImageRepository.ReadImageAsync()]
  |
  | 5. 画像変換
  |    └─> [ImageResizeService.ResizeToSquareAsync()]
  |
  | 6. 画像保存
  |    └─> [FileSystemImageRepository.SaveImageAsync()]
  |
  | 7. レスポンス生成
  |
  v
[ImageController]
  |
  | 8. HTTPレスポンス返却
  |
  v
[Client]
  |
  | 200 OK
  | {
  |   "success": true,
  |   "message": "画像を512×512に変換しました",
  |   "outputPath": "C:\\images\\output\\input_512x512.jpg"
  | }
```

---

## 5. テストシナリオ

### 5.1 正常系シナリオ

#### シナリオ1: 正常な画像変換
1. **前提条件**: 有効な画像ファイルが存在する
2. **入力**: `{ "filePath": "C:\\images\\input\\photo.jpg" }`
3. **期待結果**: 
   - HTTPステータス: 200 OK
   - `success: true`
   - 出力ファイルが生成される
   - 出力ファイルサイズ: 512×512

#### シナリオ2: 横長画像の変換
1. **前提条件**: 1920×1080のJPEG画像が存在する
2. **入力**: `{ "filePath": "C:\\images\\input\\landscape.jpg" }`
3. **期待結果**:
   - 変換後の画像: 512×288（アスペクト比維持）
   - 上下にパディング（各112px）

#### シナリオ3: 縦長画像の変換
1. **前提条件**: 1080×1920のPNG画像が存在する
2. **入力**: `{ "filePath": "C:\\images\\input\\portrait.png" }`
3. **期待結果**:
   - 変換後の画像: 288×512（アスペクト比維持）
   - 左右にパディング（各112px）

### 5.2 異常系シナリオ

#### シナリオ4: ファイルが見つからない
1. **前提条件**: 指定されたファイルが存在しない
2. **入力**: `{ "filePath": "C:\\images\\input\\nonexistent.jpg" }`
3. **期待結果**:
   - HTTPステータス: 404 Not Found
   - `success: false`
   - `errorCode: "FILE_NOT_FOUND"`

#### シナリオ5: 無効な拡張子
1. **前提条件**: サポートされていない拡張子のファイル
2. **入力**: `{ "filePath": "C:\\images\\input\\document.pdf" }`
3. **期待結果**:
   - HTTPステータス: 400 Bad Request
   - `success: false`
   - `errorCode: "INVALID_FILE_FORMAT"`

#### シナリオ6: ファイルサイズ超過
1. **前提条件**: 50MBを超える画像ファイル
2. **入力**: `{ "filePath": "C:\\images\\input\\large.jpg" }`
3. **期待結果**:
   - HTTPステータス: 400 Bad Request
   - `success: false`
   - `errorCode: "FILE_TOO_LARGE"`

---

## 6. パフォーマンス要件

### 6.1 処理時間目標

| 画像サイズ | 目標処理時間 |
|-----------|------------|
| 1MB以下 | 1秒以内 |
| 10MB以下 | 10秒以内 |
| 50MB以下 | 30秒以内 |

### 6.2 同時リクエスト対応

- 最大同時リクエスト数: 10リクエスト
- リクエストキューイング: ASP.NET Coreのデフォルト動作に従う

---

## 7. 関連ドキュメント

- [要件定義書](./要件定義書.md)
- [基本設計書](./基本設計書.md)
- [詳細設計書](./詳細設計書.md)
- [API仕様書](./API仕様書.md)
- [データ仕様書](./データ仕様書.md)

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|----------|--------|
| 1.0.0 | - | 初版作成 | - |
| 1.1.0 | - | 中央クロップ方式を追加 | - |

