# 要件定義書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | 要件定義書 |
| プロジェクト名 | img-resizer |
| バージョン | 1.0.0 |
| 作成日 | 2024年 |
| 最終更新日 | 2024年 |
| 作成者 | - |
| 承認者 | - |

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
img-resizer

### 1.2 プロジェクトの目的
指定されたファイルパスの画像を512×512ピクセルの正方形に変換するWebAPIアプリケーションを開発する。2種類の変換方式を提供する：
1. **全体変換方式**: アスペクト比を維持したリサイズとパディング処理により、画像全体を512×512の正方形に変換
2. **中央クロップ方式**: 画像の中央部分を512×512の正方形として切り出し、リサイズして変換

### 1.3 背景・課題
- 機械学習モデルや画像処理システムでは、入力画像を統一されたサイズ（正方形）に変換する必要がある
- 手動での画像変換作業は時間がかかり、ミスが発生しやすい
- 複数の画像を一括処理する必要がある
- アスペクト比を維持しながら正方形に変換する処理を自動化したい

### 1.4 解決する課題
- 画像変換作業の自動化
- 統一されたサイズ（512×512）への変換
- アスペクト比を維持した高品質な変換（全体変換方式）
- 画像の中央部分を切り出す変換（中央クロップ方式）
- WebAPI経由でのプログラム的な画像変換処理

---

## 2. 機能要件（Functional Requirements）

### 2.1 FR-001: 画像ファイルの読み込み
**優先度**: 必須

**説明**: 指定されたファイルパスから画像ファイルを読み込む機能

**詳細**:
- ファイルパスはリクエストボディで指定される
- ファイルの存在確認を行う
- サポートされている画像形式のみ処理対象とする
- ファイル読み込みエラーを適切にハンドリングする

**入力**:
- ファイルパス（文字列）

**出力**:
- 画像データ（バイト配列）
- エラーメッセージ（ファイルが見つからない場合）

**エラーケース**:
- ファイルが存在しない
- ファイルへのアクセス権限がない
- ファイルが破損している
- サポートされていない形式

### 2.2 FR-002: 画像の正方形変換（全体変換方式）
**優先度**: 必須

**説明**: 読み込んだ画像を512×512ピクセルの正方形に変換する機能（全体変換方式）。アスペクト比を維持したリサイズとパディング処理を行う。

**詳細**:
- 元画像のアスペクト比を維持する
- 512×512の正方形キャンバスに収まるようにリサイズ
- 余白部分はパディング（黒色または指定色）で埋める
- 高品質なリサンプリングアルゴリズムを使用

**変換アルゴリズム**:
1. 元画像の幅と高さを取得
2. アスペクト比を計算
3. 幅と高さのうち大きい方に合わせて512pxにスケール
4. 512×512の正方形キャンバスを作成
5. リサイズした画像を中央に配置
6. 余白をパディング色で埋める

**入力**:
- 元画像データ（バイト配列）
- ターゲットサイズ（512×512）
- 変換方式（`fit` - 全体変換方式）

**出力**:
- 変換後の画像データ（512×512、バイト配列）

### 2.2-2 FR-002-2: 画像の正方形変換（中央クロップ方式）
**優先度**: 必須

**説明**: 読み込んだ画像の中央部分を512×512ピクセルの正方形として切り出し、リサイズして変換する機能。

**詳細**:
- 画像の中央部分を正方形として切り出す
- 切り出した部分を512×512にリサイズ
- 高品質なリサンプリングアルゴリズムを使用

**変換アルゴリズム**:
1. 元画像の幅と高さを取得
2. 幅と高さのうち小さい方を取得（クロップサイズ）
3. 中央位置を計算
   - x = (Width - クロップサイズ) / 2
   - y = (Height - クロップサイズ) / 2
4. 中央部分を正方形として切り出す
5. 切り出した画像を512×512にリサイズ

**入力**:
- 元画像データ（バイト配列）
- ターゲットサイズ（512×512）
- 変換方式（`crop` - 中央クロップ方式）

**出力**:
- 変換後の画像データ（512×512、バイト配列）

**注意事項**:
- 元画像が512×512より小さい場合は、そのまま512×512に拡大する

### 2.3 FR-003: 画像ファイルの保存
**優先度**: 必須

**説明**: 変換後の画像を指定された出力ディレクトリに保存する機能

**詳細**:
- 出力ディレクトリは設定ファイルから取得
- 出力ファイル名は元のファイル名に `_512x512` を付加
- 元の画像形式を維持して保存
- 出力ディレクトリが存在しない場合は自動作成

**入力**:
- 変換後の画像データ（バイト配列）
- 出力ファイルパス

**出力**:
- 保存されたファイルパス
- エラーメッセージ（保存失敗時）

**エラーケース**:
- 出力ディレクトリへの書き込み権限がない
- ディスク容量不足
- ファイル名が無効

### 2.4 FR-004: RESTful APIエンドポイント
**優先度**: 必須

**説明**: HTTP経由で画像変換リクエストを受け付けるWebAPIエンドポイント

**詳細**:
- POSTメソッドでリクエストを受け付ける
- JSON形式のリクエストボディを処理
- JSON形式のレスポンスを返却
- 適切なHTTPステータスコードを返却

**エンドポイント**: `POST /api/image/resize`

**リクエスト形式**:
```json
{
  "filePath": "C:\\images\\input.jpg",
  "resizeMode": "fit"
}
```

**リクエストパラメータ**:
| 項目 | 型 | 必須 | 説明 | 値 |
|------|-----|------|------|-----|
| filePath | string | 必須 | 画像ファイルのパス | - |
| resizeMode | string | オプション | 変換方式 | `fit`（全体変換、デフォルト）または `crop`（中央クロップ） |

**レスポンス形式（成功）**:
```json
{
  "success": true,
  "message": "画像を512×512に変換しました",
  "outputPath": "C:\\images\\output_512x512.jpg",
  "resizeMode": "fit"
}
```

**レスポンス形式（エラー）**:
```json
{
  "success": false,
  "message": "エラーメッセージ",
  "errorCode": "ERROR_CODE"
}
```

### 2.5 FR-005: リクエストバリデーション
**優先度**: 必須

**説明**: APIリクエストの妥当性を検証する機能

**詳細**:
- ファイルパスが指定されているか
- ファイルパスが有効な形式か
- ファイル拡張子がサポートされているか
- パストラバーサル攻撃の防止

**検証項目**:
- ファイルパスが空でない
- ファイルパスが絶対パスまたは相対パスとして有効
- 拡張子が許可リストに含まれる
- ファイルパスに危険な文字列が含まれていない

### 2.6 FR-006: エラーハンドリング
**優先度**: 必須

**説明**: エラー発生時に適切なエラーレスポンスを返却する機能

**詳細**:
- エラーの種類に応じたHTTPステータスコードを返却
- エラーコードとメッセージを含むレスポンスを返却
- ログにエラー情報を記録

**エラーコード一覧**:
| エラーコード | 説明 | HTTPステータス |
|------------|------|---------------|
| `FILE_NOT_FOUND` | ファイルが見つからない | 404 |
| `INVALID_FILE_FORMAT` | サポートされていない画像形式 | 400 |
| `FILE_READ_ERROR` | ファイル読み込みエラー | 500 |
| `FILE_WRITE_ERROR` | ファイル書き込みエラー | 500 |
| `INVALID_CONFIGURATION` | 設定ファイルが不正 | 500 |
| `INVALID_REQUEST` | リクエストが不正 | 400 |
| `INTERNAL_SERVER_ERROR` | サーバー内部エラー | 500 |

### 2.7 FR-007: 設定ファイル管理
**優先度**: 必須

**説明**: アプリケーション設定を設定ファイルから読み込む機能

**詳細**:
- `appsettings.json`から設定を読み込む
- 環境ごとの設定ファイル（`appsettings.Development.json`等）に対応
- 設定値のバリデーション

**設定項目**:
- 入力ディレクトリパス
- 出力ディレクトリパス
- ターゲットサイズ（幅・高さ）
- 許可された拡張子リスト
- パディング色（オプション）
- 画像品質設定（オプション）

### 2.8 FR-008: ロギング機能
**優先度**: 推奨

**説明**: アプリケーションの動作を記録するロギング機能

**詳細**:
- リクエスト受信をログに記録
- 処理開始・完了をログに記録
- エラー発生時にログに記録
- ログレベルに応じた出力制御

**ログレベル**:
- Information: 正常な処理完了
- Warning: 警告（設定値のデフォルト使用等）
- Error: エラー（例外発生）
- Debug: デバッグ情報（開発環境のみ）

---

## 3. 非機能要件（Non-Functional Requirements）

### 3.1 NFR-001: パフォーマンス
**優先度**: 中

**要件**:
- 1MB以下の画像ファイルを1秒以内に処理できること
- 10MB以下の画像ファイルを10秒以内に処理できること
- 同時リクエスト数は10リクエストまで対応可能であること

**測定方法**:
- 単体テストで処理時間を測定
- 負荷テストで同時リクエスト処理を検証

### 3.2 NFR-002: 可用性
**優先度**: 中

**要件**:
- アプリケーションの稼働率は95%以上であること
- 予期しないエラーが発生してもアプリケーションがクラッシュしないこと

**対策**:
- 適切な例外処理
- グローバルエラーハンドラー
- リソースの適切な解放

### 3.3 NFR-003: セキュリティ
**優先度**: 高

**要件**:
- パストラバーサル攻撃を防止すること
- ファイルサイズ制限を設けること（推奨: 50MB以下）
- 許可された拡張子のみ処理すること
- 入力値の検証を徹底すること

**対策**:
- ファイルパスの正規化と検証
- ファイルサイズチェック
- 拡張子のホワイトリスト検証
- 入力値のサニタイゼーション

### 3.4 NFR-004: 保守性
**優先度**: 高

**要件**:
- クリーンアーキテクチャの原則に従った設計
- 各レイヤーが独立してテスト可能であること
- コードの可読性が高いこと

**対策**:
- レイヤー分離の徹底
- インターフェースによる依存関係の逆転
- 単体テストの実装
- コードレビューの実施

### 3.5 NFR-005: 拡張性
**優先度**: 低

**要件**:
- 将来的に他のサイズへの対応が容易であること
- 新しい画像形式の追加が容易であること
- バッチ処理機能の追加が容易であること

**対策**:
- 設定ファイルによるサイズ指定
- プラグイン的な画像形式対応
- ユースケースの分離

### 3.6 NFR-006: 互換性
**優先度**: 必須

**要件**:
- .NET 8.0 SDK以上で動作すること
- Windows、Linux、macOSで動作すること（可能な範囲で）
- 以下の画像形式をサポートすること:
  - JPEG (.jpg, .jpeg)
  - PNG (.png)
  - GIF (.gif)
  - BMP (.bmp)

### 3.7 NFR-007: ドキュメント
**優先度**: 中

**要件**:
- API仕様書を提供すること
- Swagger/OpenAPIドキュメントを提供すること
- 開発者向けドキュメントを提供すること

---

## 4. 制約条件

### 4.1 技術的制約
- **フレームワーク**: .NET 8.0以上を使用すること
- **アーキテクチャ**: クリーンアーキテクチャの原則に従うこと
- **API**: ASP.NET Core WebAPIを使用すること
- **画像処理**: SixLabors.ImageSharpライブラリを使用すること（クロスプラットフォーム対応）

### 4.2 環境的制約
- 開発環境: Windows 10/11、.NET 8.0 SDK
- 実行環境: .NET 8.0 Runtime以上
- ファイルシステム: ローカルファイルシステムへのアクセスが必要

### 4.3 ビジネス制約
- 開発期間: 制限あり（要確認）
- 予算: オープンソースライブラリの使用を優先
- ライセンス: 商用利用可能なライブラリのみ使用

### 4.4 法的制約
- 使用するライブラリのライセンスに準拠すること
- 個人情報保護に関する法規制に準拠すること（該当する場合）

---

## 5. 前提条件

### 5.1 技術的前提
- .NET 8.0 SDKがインストールされていること
- 開発環境にVisual Studio 2022またはVisual Studio Codeがインストールされていること
- 画像ファイルがローカルファイルシステムに存在すること

### 5.2 環境的前提
- 入力画像ファイルへの読み込み権限があること
- 出力ディレクトリへの書き込み権限があること
- 十分なディスク容量があること

### 5.3 ユーザー前提
- APIの利用者はHTTPリクエストを送信できること
- ファイルパスの形式を理解していること
- JSON形式のリクエスト/レスポンスを扱えること

---

## 6. スコープ

### 6.1 本プロジェクトに含まれる機能（In-Scope）
- ✅ 画像ファイルの読み込み
- ✅ 512×512への正方形変換（全体変換方式）
- ✅ 512×512への正方形変換（中央クロップ方式）
- ✅ RESTful APIエンドポイント
- ✅ 設定ファイルからの設定読み込み
- ✅ エラーハンドリング
- ✅ ロギング
- ✅ 単体テスト・統合テスト

### 6.2 本プロジェクトに含まれない機能（Out-of-Scope）
- ❌ 画像のアップロード機能（ファイルパス指定のみ）
- ❌ 認証・認可機能
- ❌ 画像のメタデータ保持
- ❌ バッチ処理機能（複数ファイルの一括処理）
- ❌ 非同期処理の実装（将来的な拡張）
- ❌ 画像の品質設定（圧縮率等）
- ❌ Web UI（APIのみ）
- ❌ データベース連携
- ❌ クラウドストレージ連携

### 6.3 将来の拡張候補（Future Scope）
- 複数サイズへの対応（512×512以外）
- バッチ処理機能
- 画像のメタデータ保持
- 非同期処理
- 画像の品質設定
- 認証・認可機能
- クラウドストレージ連携

---

## 7. 用語定義

| 用語 | 説明 |
|------|------|
| **アスペクト比** | 画像の幅と高さの比率 |
| **パディング** | 画像の周囲に余白を追加すること |
| **リサンプリング** | 画像のサイズを変更する際の画素補間処理 |
| **クリーンアーキテクチャ** | レイヤー分離と依存関係の逆転を重視したアーキテクチャパターン |
| **ユースケース** | アプリケーションが提供する機能の単位 |
| **DTO** | Data Transfer Object（データ転送オブジェクト） |
| **DI** | Dependency Injection（依存性注入） |
| **パストラバーサル** | ファイルパスを操作して不正なファイルにアクセスする攻撃手法 |

---

## 8. 関連ドキュメント

- [基本設計書](./基本設計書.md)
- [詳細設計書](./詳細設計書.md)
- [API仕様書](./API仕様書.md)
- [機能仕様書](./機能仕様書.md)
- [データ仕様書](./データ仕様書.md)
- [README.md](../README.md)

---

## 9. 承認履歴

| バージョン | 日付 | 承認者 | 承認内容 |
|-----------|------|--------|----------|
| 1.0.0 | - | - | 初版作成 |

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|----------|--------|
| 1.0.0 | - | 初版作成 | - |
| 1.1.0 | - | 中央クロップ方式を追加 | - |

