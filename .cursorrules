# Cursor Rules for img-resizer Project

## プロジェクト概要
このプロジェクトは、画像を512×512の正方形に変換するASP.NET Core WebAPIアプリケーションです。
クリーンアーキテクチャの原則に基づいて設計されています。

## 技術スタック
- **言語**: C# (.NET 8.0)
- **フレームワーク**: ASP.NET Core WebAPI
- **アーキテクチャ**: クリーンアーキテクチャ + CQRS
- **画像処理**: System.Drawing.Common（SixLabors.ImageSharpへ移行予定）
- **エラーハンドリング**: ✅ Resultパターン + グローバル例外ハンドラー（実装完了: 2025-12-01）
- **ロギング**: Microsoft.Extensions.Logging（Serilogへ移行予定）
- **バリデーション**: ✅ FluentValidation（実装完了: 2025-12-01）
- **メディエーター**: ✅ MediatR（実装完了: 2025-12-02）
- **静的解析**: ✅ Roslyn Analyzers、StyleCop、SonarAnalyzer、Roslynator（実装完了: 2025-12-01）

## 開発方針

### アーキテクチャ原則
- クリーンアーキテクチャの原則に厳密に従う
- ✅ CQRS（Command Query Responsibility Segregation）パターンを採用 **実装完了: 2025-12-02**
- ✅ MediatRを使用したCommand/Queryの実装 **実装完了: 2025-12-02**
- レイヤー間の依存関係を明確に保つ
  - Domain層: 他のレイヤーに依存しない
  - Application層: Domain層のみに依存
  - Infrastructure層: Domain層に依存
  - Presentation層: Application層とInfrastructure層に依存
- インターフェースによる依存関係の逆転を徹底する
- ✅ **Resultパターンを使用**（例外駆動からResult駆動へ）**実装完了: 2025-12-01**
- ✅ **グローバル例外ハンドラーを使用**（予期しない例外の一元管理）**実装完了: 2025-12-01**

### コーディング規約
- C# のコーディング規約に従う（.editorconfigで強制）
- 静的解析ツール（StyleCop、SonarAnalyzer）の警告に従う（導入完了、警告0個）
- 非同期処理は `async/await` を使用
- リソース管理は `using` ステートメントを適切に使用
- null許容参照型を有効に活用
- ✅ **Resultパターンで例外を使わない設計を優先**（実装完了）
- ✅ **バリデーションはFluentValidationを使用**（実装完了）
- ✅ **XMLドキュメントコメントを記述**（実装完了: 2025-12-01）
  - すべてのpublicクラス、メソッド、プロパティにコメント追加
  - IntelliSenseでコメントが表示されるよう適切に記述
- 構造化ログ（Serilogへ移行予定）

### 命名規則
- クラス名: PascalCase
- メソッド名: PascalCase
- 変数名: camelCase
- プライベートフィールド: _camelCase（アンダースコアプレフィックス）
- インターフェース: `I` プレフィックス（例: `IImageRepository`）
- エンティティ: ドメイン名を含む（例: `ImageFile`）
- DTO: 用途を明確に（例: `ResizeImageRequest`）
- Command: `~Command`（例: `ResizeImageCommand`）
- Query: `~Query`（例: `GetImageQuery`）
- Handler: `~Handler`（例: `ResizeImageCommandHandler`）
- Validator: `~Validator`（例: `ResizeImageCommandValidator`）

### ファイル構造
```
img-resizer/
├── src/
│   ├── ImgResizer.Api/              # Presentation層
│   ├── ImgResizer.Application/       # Application層
│   ├── ImgResizer.Domain/            # Domain層
│   └── ImgResizer.Infrastructure/    # Infrastructure層
├── tests/                            # テストプロジェクト
└── docs/                             # ドキュメント
```

## ドキュメント作成ルール

### 言語
- **すべてのドキュメントは日本語で作成する**
- コードコメントも日本語で記述する

### ドキュメント構成
- 要件定義書: `docs/要件定義書.md` ✅ 作成済み
- 機能仕様書: `docs/機能仕様書.md` ✅ 作成済み
- API仕様書: `docs/API仕様書.md` ✅ 作成済み
- データ仕様書: `docs/データ仕様書.md` ✅ 作成済み
- 基本設計書: `docs/基本設計書.md` ✅ 作成済み
- 詳細設計書: `docs/詳細設計書.md` ✅ 作成済み
- エラーハンドリング仕様書: `docs/エラーハンドリング仕様書.md` ✅ 作成済み
- リファクタリング改善案: `docs/リファクタリング改善案.md` ✅ 作成済み
- ドキュメント一覧: `docs/ドキュメント一覧.md` ✅ 作成済み
- 開発ガイド: `docs/クイックスタートガイド.md`, `docs/Gitセットアップガイド.md` など

### スペック開発
- 開発前に詳細な仕様書を作成する
- 仕様書に基づいて実装する
- 仕様変更時は必ず仕様書を更新する

## コード生成時の注意事項

### 必須事項
1. 既存のアーキテクチャパターンに従う
2. レイヤー分離を厳守する
3. インターフェースを定義してから実装する
4. ✅ **Resultパターンを使用する**（例外を安易に使わない）**実装済み**
5. ✅ **FluentValidationでバリデーションを実装する** **実装済み**
6. ✅ **XMLドキュメントコメントを記述する**（すべてのpublicメンバー）**実装済み**
7. ✅ **MediatRを使用してCommand/Queryを実装する** **実装済み**
8. 構造化ログを実装する（Serilog導入予定）
9. ✅ **静的解析ツールの警告に対応する**（警告0個を維持）**実装済み**

### 禁止事項
1. レイヤー間の直接的な依存関係を作らない
2. ビジネスロジックをPresentation層に書かない
3. 外部ライブラリへの直接依存をDomain層に作らない
4. ハードコードされた値を使用しない（設定ファイルから読み込む）
5. ✅ **正常系フローで例外を使わない**（Resultパターンを使用）**実装済み**
6. ✅ **バリデーションロジックをUseCaseに直接書かない**（FluentValidation使用）**実装済み**

### 画像処理の実装
- 現在: System.Drawing.Common（Windows専用）
- 移行予定: SixLabors.ImageSharp（クロスプラットフォーム対応）
- アスペクト比を維持したリサイズ
- 高品質なリサンプリングアルゴリズムを使用
- メモリリークを防ぐため、`using` ステートメントでリソースを適切に解放
- 非同期I/O操作を使用
- ✅ CancellationTokenを適切に使用（MediatRで対応済み）

### セキュリティ
- パストラバーサル攻撃を防止
- ファイルサイズ制限を実装
- 拡張子のホワイトリスト検証
- 入力値のバリデーションを徹底

## テスト
- ✅ **単体テストを各レイヤーで実装** **実装完了: 2025-12-02**
  - Domain層: 4テスト（Resultクラス）
  - Application層: 28テスト（CommandHandler、Validator、Behavior）
  - Infrastructure層: 21テスト（Repository、Service）
- ✅ **統合テストでAPIエンドポイントを検証** **実装完了: 2025-12-02**
  - Api層: 9テスト（ImageController）
- ✅ **総テスト数: 62テスト、すべて成功（0失敗）** **実装完了: 2025-12-02**
- モックを使用してレイヤー間の依存を分離
- テストカバレッジを維持（目標: 80%以上）
- FluentAssertionsを使用した読みやすいアサーション
- xUnit、Moq、Microsoft.AspNetCore.Mvc.Testingを使用

## エラーハンドリング
- ✅ **Resultパターンを使用**（正常系と異常系の明示的な分離）**実装完了: 2025-12-01**
  - Domain層に`Result`クラスと`Result<T>`クラスを実装
  - Infrastructure層、Application層、Presentation層で全面的に採用
  - Controllerのコード量を約50%削減（115行→55行）
- ✅ **グローバル例外ハンドラーで一元管理** **実装完了: 2025-12-01**
  - `GlobalExceptionHandlerMiddleware`による予期しない例外の一元処理
  - すべてのドメイン例外を適切なHTTPステータスコードにマッピング
  - 開発環境と本番環境で異なるエラーメッセージ詳細度
- カスタム例外クラスは例外的な状況でのみ使用
- ✅ エラーコードを定義（エラーハンドリング仕様書参照）
- ✅ 適切なHTTPステータスコードを返却
- エラーログを記録（構造化ログへ移行予定）
- 詳細は `docs/エラーハンドリング仕様書.md` を参照

## API設計
- RESTful APIの原則に従う
- JSON形式のリクエスト/レスポンス
- 適切なHTTPステータスコード
- Swagger/OpenAPIドキュメントを提供

## 設定管理
- `appsettings.json` から設定を読み込む
- 環境ごとの設定ファイルに対応
- IOptionsパターンを使用
- IValidateOptions<T>で設定値のバリデーションを実装
- ValidateOnStartで起動時に設定を検証

## コミットメッセージ
- 日本語で記述
- 変更内容を明確に記述
- 関連する要件IDやチケット番号を記載

## コードレビュー
- アーキテクチャ原則の遵守を確認
- セキュリティ要件の遵守を確認
- テストの実装を確認
- ドキュメントの更新を確認
- 静的解析ツールの警告がないことを確認
- Resultパターンの適切な使用を確認
- FluentValidationの実装を確認

## 静的解析・品質管理
- .editorconfigでコーディングスタイルを統一
- StyleCop Analyzersでコーディング規約を強制
- SonarAnalyzer.CSharpでバグ・脆弱性を検出
- Roslynatorでコード改善提案を取得
- CSharpierで自動フォーマット
- CI/CDパイプラインで自動チェック

## ロギング
- 現在: Microsoft.Extensions.Logging
- 移行予定: Serilogを使用した構造化ログ
- ログレベルの適切な使用（Debug, Information, Warning, Error）
- 構造化プロパティを使用予定（`{PropertyName}`記法）
- LogContextで追加プロパティを設定予定
- 開発環境ではSeqを使用したログ可視化予定

## モダンな設計パターン

### 実装済み
- ✅ **Resultパターン** (2025-12-01): 例外駆動からResult駆動へ
  - `ImgResizer.Domain.Common.Result`および`Result<T>`を実装
  - 全レイヤーで採用完了
- ✅ **グローバル例外ハンドラー** (2025-12-01): 予期しない例外の一元管理
  - `GlobalExceptionHandlerMiddleware`による一元処理
  - エラーレスポンスの統一とHTTPステータスコードの自動マッピング
- ✅ **FluentValidation** (2025-12-01): バリデーションロジックの分離
  - `ResizeImageRequestValidator`による宣言的バリデーション
  - UseCaseから約30行のバリデーションコードを削減
  - 再利用可能で保守性の高いバリデーション
- ✅ **静的解析ツール** (2025-12-01): コード品質の自動チェック
  - StyleCop、SonarAnalyzer、Roslynator導入
  - 警告数: 237個 → 0個（100%解消）
- ✅ **XMLドキュメントコメント** (2025-12-01): コードドキュメントの充実
  - すべてのpublicクラス、メソッド、プロパティにコメント追加
  - IntelliSenseでコメント表示に対応
- ✅ **MediatR + CQRS** (2025-12-02): Command/Queryの明確な分離
  - `ResizeImageCommand`と`ResizeImageCommandHandler`を実装
  - `ValidationBehavior`によるパイプラインバリデーション
  - CancellationTokenの一貫した使用

### 導入予定（優先度: 中）
- **ImageSharp**: System.Drawing.Commonからの移行
- **Serilog**: 構造化ログの強化
- **設定クラスの強化**: IValidateOptions<T>による検証

### 検討中（優先度: 低）
- **ドメインイベント**: ビジネスイベントの明示的な表現
- **Minimal API**: 軽量でモダンなAPI設計

## リファクタリング

### 実施済み
- ✅ **フェーズ1-1: Resultパターン導入** (2025-12-01)
  - 実装完了、ビルド成功、アプリケーション正常稼働確認済み
- ✅ **フェーズ1-2: グローバル例外ハンドラー実装** (2025-12-01)
  - 実装完了、ビルド成功、アプリケーション正常起動確認済み
- ✅ **フェーズ1-3: FluentValidation導入** (2025-12-01)
  - 実装完了、ビルド成功、アプリケーション正常起動確認済み
- ✅ **フェーズ1-4: 静的解析ツール導入** (2025-12-01)
  - 実装完了、ビルド成功確認済み
- ✅ **フェーズ1-5: 静的解析の全警告修正** (2025-12-01)
  - 警告数: 237個 → 0個（100%解消）
- ✅ **フェーズ1-6: XMLドキュメントコメント追加** (2025-12-01)
  - 全レイヤーのpublicメンバーにコメント追加完了
  
**フェーズ1完全完了！🎉**

### フェーズ2: 実施済み
- ✅ **フェーズ2: MediatR + CQRS実装** (2025-12-02)
  - `ResizeImageCommand`と`ResizeImageCommandHandler`を実装
  - `ResizeImageCommandValidator`を実装
  - `ValidationBehavior`によるパイプラインバリデーション
  - `ImageController`をMediatR対応に更新
  - ビルド成功、警告0個達成

**フェーズ2完全完了！🎉**

### フェーズ3: 実施済み
- ✅ **フェーズ3: テストコード実装** (2025-12-02)
  - Domain層: 4テスト（Resultクラス）
  - Application層: 28テスト（CommandHandler、Validator、Behavior）
  - Infrastructure層: 21テスト（Repository、Service）
  - Api層: 9テスト（ImageController統合テスト）
  - 総テスト数: 62テスト、すべて成功（0失敗）
  - テストプロジェクト構成完了
  - xUnit、FluentAssertions、Moq、Microsoft.AspNetCore.Mvc.Testingを使用

**フェーズ3完全完了！🎉**

### 次のステップ（フェーズ4）
- ImageSharp導入
- Serilog導入
- 設定クラスの強化
- テストカバレッジの測定とレポート生成

### リファクタリング方針
- モダンな設計への移行は段階的に実施
- 詳細は `docs/リファクタリング改善案.md` を参照
- 既存コードとの互換性を保ちながら改善
- ビルドエラーゼロを維持しながら進める

