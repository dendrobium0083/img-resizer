# Cursor Rules for img-resizer Project

## プロジェクト概要
このプロジェクトは、画像を512×512の正方形に変換するASP.NET Core WebAPIアプリケーションです。
クリーンアーキテクチャの原則に基づいて設計されています。

## 技術スタック
- **言語**: C# (.NET 8.0)
- **フレームワーク**: ASP.NET Core WebAPI
- **アーキテクチャ**: クリーンアーキテクチャ + CQRS
- **画像処理**: SixLabors.ImageSharp（System.Drawing.Commonから移行予定）
- **ロギング**: Serilog（構造化ログ）
- **バリデーション**: FluentValidation
- **メディエーター**: MediatR
- **静的解析**: Roslyn Analyzers、StyleCop、SonarAnalyzer

## 開発方針

### アーキテクチャ原則
- クリーンアーキテクチャの原則に厳密に従う
- CQRS（Command Query Responsibility Segregation）パターンを採用
- MediatRを使用したCommand/Queryの実装
- レイヤー間の依存関係を明確に保つ
  - Domain層: 他のレイヤーに依存しない
  - Application層: Domain層のみに依存
  - Infrastructure層: Domain層に依存
  - Presentation層: Application層とInfrastructure層に依存
- インターフェースによる依存関係の逆転を徹底する
- Resultパターンを使用（例外駆動からResult駆動へ）

### コーディング規約
- C# のコーディング規約に従う（.editorconfigで強制）
- 静的解析ツール（StyleCop、SonarAnalyzer）の警告に従う
- 非同期処理は `async/await` を使用
- リソース管理は `using` ステートメントを適切に使用
- null許容参照型を有効に活用
- Resultパターンで例外を使わない設計を優先
- バリデーションはFluentValidationを使用
- 構造化ログ（Serilog）を使用

### 命名規則
- クラス名: PascalCase
- メソッド名: PascalCase
- 変数名: camelCase
- プライベートフィールド: _camelCase（アンダースコアプレフィックス）
- インターフェース: `I` プレフィックス（例: `IImageRepository`）
- エンティティ: ドメイン名を含む（例: `ImageFile`）
- DTO: 用途を明確に（例: `ResizeImageRequest`）
- Command: `~Command`（例: `ResizeImageCommand`）
- Query: `~Query`（例: `GetImageQuery`）
- Handler: `~Handler`（例: `ResizeImageCommandHandler`）
- Validator: `~Validator`（例: `ResizeImageCommandValidator`）

### ファイル構造
```
img-resizer/
├── src/
│   ├── ImgResizer.Api/              # Presentation層
│   ├── ImgResizer.Application/       # Application層
│   ├── ImgResizer.Domain/            # Domain層
│   └── ImgResizer.Infrastructure/    # Infrastructure層
├── tests/                            # テストプロジェクト
└── docs/                             # ドキュメント
```

## ドキュメント作成ルール

### 言語
- **すべてのドキュメントは日本語で作成する**
- コードコメントも日本語で記述する

### ドキュメント構成
- 要件定義書: `docs/要件定義書.md` ✅ 作成済み
- 機能仕様書: `docs/機能仕様書.md` ✅ 作成済み
- API仕様書: `docs/API仕様書.md` ✅ 作成済み
- データ仕様書: `docs/データ仕様書.md` ✅ 作成済み
- 基本設計書: `docs/基本設計書.md` ✅ 作成済み
- 詳細設計書: `docs/詳細設計書.md` ✅ 作成済み
- エラーハンドリング仕様書: `docs/エラーハンドリング仕様書.md` ✅ 作成済み
- リファクタリング改善案: `docs/リファクタリング改善案.md` ✅ 作成済み
- ドキュメント一覧: `docs/ドキュメント一覧.md` ✅ 作成済み
- 開発ガイド: `docs/クイックスタートガイド.md`, `docs/Gitセットアップガイド.md` など

### スペック開発
- 開発前に詳細な仕様書を作成する
- 仕様書に基づいて実装する
- 仕様変更時は必ず仕様書を更新する

## コード生成時の注意事項

### 必須事項
1. 既存のアーキテクチャパターンに従う
2. レイヤー分離を厳守する
3. インターフェースを定義してから実装する
4. Resultパターンを使用する（例外を安易に使わない）
5. FluentValidationでバリデーションを実装する
6. MediatRを使用してCommand/Queryを実装する
7. Serilogで構造化ログを実装する
8. 静的解析ツールの警告に対応する

### 禁止事項
1. レイヤー間の直接的な依存関係を作らない
2. ビジネスロジックをPresentation層に書かない
3. 外部ライブラリへの直接依存をDomain層に作らない
4. ハードコードされた値を使用しない（設定ファイルから読み込む）
5. 正常系フローで例外を使わない（Resultパターンを使用）
6. バリデーションロジックをUseCaseに直接書かない

### 画像処理の実装
- SixLabors.ImageSharpを使用（クロスプラットフォーム対応）
- アスペクト比を維持したリサイズ
- 高品質なリサンプリングアルゴリズムを使用
- メモリリークを防ぐため、`using` ステートメントでリソースを適切に解放
- 非同期I/O操作を使用
- CancellationTokenを適切に使用

### セキュリティ
- パストラバーサル攻撃を防止
- ファイルサイズ制限を実装
- 拡張子のホワイトリスト検証
- 入力値のバリデーションを徹底

## テスト
- 単体テストを各レイヤーで実装
- モックを使用してレイヤー間の依存を分離
- 統合テストでAPIエンドポイントを検証
- テストカバレッジを維持（目標: 80%以上）
- FluentAssertionsを使用した読みやすいアサーション

## エラーハンドリング
- Resultパターンを使用（正常系と異常系の明示的な分離）
- カスタム例外クラスは例外的な状況でのみ使用
- グローバル例外ハンドラーで一元管理
- エラーコードを定義（エラーハンドリング仕様書参照）
- 適切なHTTPステータスコードを返却
- Serilogでエラーログを記録
- 詳細は `docs/エラーハンドリング仕様書.md` を参照

## API設計
- RESTful APIの原則に従う
- JSON形式のリクエスト/レスポンス
- 適切なHTTPステータスコード
- Swagger/OpenAPIドキュメントを提供

## 設定管理
- `appsettings.json` から設定を読み込む
- 環境ごとの設定ファイルに対応
- IOptionsパターンを使用
- IValidateOptions<T>で設定値のバリデーションを実装
- ValidateOnStartで起動時に設定を検証

## コミットメッセージ
- 日本語で記述
- 変更内容を明確に記述
- 関連する要件IDやチケット番号を記載

## コードレビュー
- アーキテクチャ原則の遵守を確認
- セキュリティ要件の遵守を確認
- テストの実装を確認
- ドキュメントの更新を確認
- 静的解析ツールの警告がないことを確認
- Resultパターンの適切な使用を確認
- FluentValidationの実装を確認

## 静的解析・品質管理
- .editorconfigでコーディングスタイルを統一
- StyleCop Analyzersでコーディング規約を強制
- SonarAnalyzer.CSharpでバグ・脆弱性を検出
- Roslynatorでコード改善提案を取得
- CSharpierで自動フォーマット
- CI/CDパイプラインで自動チェック

## ロギング
- Serilogを使用した構造化ログ
- ログレベルの適切な使用（Verbose, Debug, Information, Warning, Error, Fatal）
- 構造化プロパティを使用（`{PropertyName}`記法）
- LogContextで追加プロパティを設定
- 開発環境ではSeqを使用したログ可視化

## モダンな設計パターン
- **Resultパターン**: 例外駆動からResult駆動へ
- **CQRSパターン**: Command/Queryの明確な分離
- **MediatRパイプライン**: バリデーション、ログ、トランザクション管理
- **ドメインイベント**: ビジネスイベントの明示的な表現
- **Minimal API**: 軽量でモダンなAPI設計（検討中）

## リファクタリング
- モダンな設計への移行は段階的に実施
- 詳細は `docs/リファクタリング改善案.md` を参照
- 既存コードとの互換性を保ちながら改善

